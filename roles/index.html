<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚Ø³ÛŒÙ… Ù†Ù‚Ø´â€ŒÙ‡Ø§ - Ù…Ø­Ø±Ù…Ø§Ù†Ù‡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: Tahoma, sans-serif;
            direction: rtl;
            background-color: #f9f9f9;
            padding: 20px;
        }
        .button.used {
            background-color: #6c757d;
            cursor: default;
        }
        #roleDisplay {
            margin-top: 20px;
            display: none;
        }
        #godButton {
            margin-top: 100px;
        }
        #timerSection {
            margin-top: 40px;
        }
        .timerBox {
            margin: 30px 0;
        }
        .timerDisplay {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        #buttonContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            justify-items: center;
        }
    </style>
</head>
<body class="container text-center">
<audio id="alarmSound" src="alarm.mp3" preload="auto"></audio>

<div class="controls mb-4">
    <label for="playerCount" class="form-label">ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† (Û· ØªØ§ Û±Û´):</label>
    <input type="number" id="playerCount" class="form-control w-25 d-inline" min="7" max="14" value="10">
    <button class="btn btn-primary ms-2" onclick="startGame()"><i class="bi bi-shuffle"></i> Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
</div>

<div class="container d-grid gap-3 justify-content-center" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));" id="buttonContainer"></div>

<div id="roleDisplay" class="mt-4">
    <p><strong>Ù†Ù‚Ø´:</strong> <span id="shownRole"></span></p>
    <div class="input-group mb-3 w-50 mx-auto">
        <span class="input-group-text">Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†</span>
        <input type="text" id="playerName" class="form-control" onkeydown="handleEnter(event)">
    </div>
    <button class="btn btn-success" onclick="confirmPlayer()">
        <i class="bi bi-check-circle"></i> ØªØ£ÛŒÛŒØ¯
    </button>
</div>

<div style="height: 100px;"></div>
<button id="godButton" class="btn btn-danger" onclick="showGodView()"><i class="bi bi-list-ul"></i> Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù†Ù‚Ø´â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú¯Ø±Ø¯Ø§Ù†Ù†Ø¯Ù‡</button>
<div id="godView" class="mt-4 text-end"></div>

<div id="timerSection">
    <h3>â³ ØªØ§ÛŒÙ…Ø± Ø¨Ø§Ø²ÛŒ</h3>

    <div class="timerBox">
        <h4>ØªØ§ÛŒÙ…Ø± ØµØ­Ø¨Øª (Û¶Û° Ø«Ø§Ù†ÛŒÙ‡)</h4>
        <div id="talkTimer" class="timerDisplay">--:--</div>
        <button class="btn btn-success me-2" onclick="startTimer('talk', 60)"><i class="bi bi-play-fill"></i> Ø´Ø±ÙˆØ¹</button>
        <button class="btn btn-danger" onclick="stopTimer('talk')"><i class="bi bi-stop-fill"></i> ØªÙˆÙ‚Ù</button>
    </div>

    <div class="timerBox">
        <h4>ØªØ§ÛŒÙ…Ø± Ú†Ø§Ù„Ø´ / Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ (Û³Û° Ø«Ø§Ù†ÛŒÙ‡)</h4>
        <div id="challengeTimer" class="timerDisplay">--:--</div>
        <button class="btn btn-success me-2" onclick="startTimer('challenge', 30)"><i class="bi bi-play-fill"></i> Ø´Ø±ÙˆØ¹</button>
        <button class="btn btn-danger" onclick="stopTimer('challenge')"><i class="bi bi-stop-fill"></i> ØªÙˆÙ‚Ù</button>
    </div>

    <div class="timerBox">
        <h4>ØªØ§ÛŒÙ…Ø± Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ (Ûµ Ø«Ø§Ù†ÛŒÙ‡)</h4>
        <div id="testTimer" class="timerDisplay">--:--</div>
        <button class="btn btn-success me-2" onclick="startTimer('test', 5)"><i class="bi bi-play-fill"></i> Ø´Ø±ÙˆØ¹</button>
        <button class="btn btn-danger" onclick="stopTimer('test')"><i class="bi bi-stop-fill"></i> ØªÙˆÙ‚Ù</button>
    </div>
</div>

<script>
    const rolesByCount = {
        7: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"],
        8: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"],
        9: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²", "Ø²Ø±Ù‡â€ŒÙ¾ÙˆØ´", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"],
        10: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ¯Ø±", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "Ø®Ø¨Ø±Ù†Ú¯Ø§Ø±", "ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²", "Ø²Ø±Ù‡â€ŒÙ¾ÙˆØ´", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"],
        11: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ¯Ø±", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "Ø®Ø¨Ø±Ù†Ú¯Ø§Ø±", "ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"],
        12: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ¯Ø±", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "Ø®Ø¨Ø±Ù†Ú¯Ø§Ø±", "ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²", "Ø²Ø±Ù‡â€ŒÙ¾ÙˆØ´", "Ú©Ù†Ø³ØªØ§Ù†ØªÛŒÙ†", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"],
        13: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ¯Ø±", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "Ø®Ø¨Ø±Ù†Ú¯Ø§Ø±", "ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²", "Ø²Ø±Ù‡â€ŒÙ¾ÙˆØ´", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"],
        14: ["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ¯Ø±", "Ø¬ÙˆÚ©Ø±", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡", "Ù¾Ø²Ø´Ú©", "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡", "Ø®Ø¨Ø±Ù†Ú¯Ø§Ø±", "ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²", "Ø²Ø±Ù‡â€ŒÙ¾ÙˆØ´", "Ú©Ù†Ø³ØªØ§Ù†ØªÛŒÙ†", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡", "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡"]
    };

    let currentRoles = [];
    let currentIndex = -1;
    const assignments = [];
    const timers = { talk: null, challenge: null, test: null };

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function startGame() {
        const count = parseInt(document.getElementById("playerCount").value);
        if (count < 7 || count > 14) {
            alert("Ø¹Ø¯Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û· ØªØ§ Û±Û´ Ø¨Ø§Ø´Ø¯.");
            return;
        }
        currentRoles = [...rolesByCount[count]];
        shuffle(currentRoles);
        const container = document.getElementById("buttonContainer");
        container.innerHTML = "";
        assignments.length = 0;
        for (let i = 0; i < count; i++) {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline-primary btn-lg fw-bold fs-4";
            btn.textContent = i + 1;
            btn.onclick = () => handleClick(i, btn);
            container.appendChild(btn);
        }
    }

    function handleClick(index, btn) {
        if (btn.classList.contains("used")) return;
        currentIndex = index;
        btn.classList.add("used");
        btn.disabled = true;
        btn.textContent = "â“";
        document.getElementById("shownRole").textContent = currentRoles[index];
        document.getElementById("playerName").value = "";
        document.getElementById("roleDisplay").style.display = "block";
        document.getElementById("playerName").focus();
    }

    function handleEnter(event) {
        if (event.key === "Enter") confirmPlayer();
    }

    function confirmPlayer() {
        const name = document.getElementById("playerName").value.trim();
        if (!name) return alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
        assignments[currentIndex] = { name, role: currentRoles[currentIndex] };
        document.getElementById("roleDisplay").style.display = "none";
    }

    function showGodView() {
        const mafiaRoles = [];
        const citizenRoles = [];
        currentRoles.forEach((role, i) => {
            const entry = assignments[i];
            const name = entry ? entry.name : "Ø¨Ø§Ø²ÛŒÚ©Ù† " + (i + 1);
            const pair = { name: name, role: role };

            if (["Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§", "Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ¯Ø±", "Ø¬ÙˆÚ©Ø±", "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡"].includes(role)) {
                mafiaRoles.push(pair);
            } else {
                citizenRoles.push(pair);
            }
        });

        function getPriority(role) {
            const priorities = {
                "Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§": 100,
                "Ø¬ÙˆÚ©Ø±": 90,
                "Ù…Ø°Ø§Ú©Ø±Ù‡â€ŒÚ¯Ø±": 85,
                "Ù…Ø§ÙÛŒØ§ÛŒ Ø³Ø§Ø¯Ù‡": 80,
                "Ù¾Ø²Ø´Ú©": 100,
                "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡": 95,
                "Ø®Ø¨Ø±Ù†Ú¯Ø§Ø±": 85,
                "ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²": 80,
                "Ø²Ø±Ù‡â€ŒÙ¾ÙˆØ´": 70,
                "Ú©Ù†Ø³ØªØ§Ù†ØªÛŒÙ†": 65,
                "Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡": 50
            };
            return priorities[role] || 0;
        }

        mafiaRoles.sort((a, b) => getPriority(b.role) - getPriority(a.role));
        citizenRoles.sort((a, b) => getPriority(b.role) - getPriority(a.role));

        let html = '<h3>ğŸ“‹ Ù„ÛŒØ³Øª Ù†Ù‡Ø§ÛŒÛŒ Ù†Ù‚Ø´â€ŒÙ‡Ø§:</h3>';
        html += '<h4 style="color:#b30000">ğŸŸ¥ ØªÛŒÙ… Ù…Ø§ÙÛŒØ§:</h4><ul>';
        mafiaRoles.forEach(entry => {
            html += `<li>${entry.name}: ${entry.role}</li>`;
        });
        html += '</ul>';

        html += '<h4 style="color:#004080">ğŸŸ¦ ØªÛŒÙ… Ø´Ù‡Ø±ÙˆÙ†Ø¯Ø§Ù†:</h4><ul>';
        citizenRoles.forEach(entry => {
            html += `<li>${entry.name}: ${entry.role}</li>`;
        });
        html += '</ul>';
        document.getElementById("godView").innerHTML = html;
    }

    function playAlarm() {
        const sound = document.getElementById("alarmSound");
        if (sound) {
            sound.pause();
            sound.currentTime = 0;
            sound.play().catch(e => console.warn("Audio play failed:", e));
        }
    }

    function startTimer(type, seconds) {
        clearInterval(timers[type]);
        let time = seconds;
        const display = document.getElementById(type + "Timer");
        timers[type] = setInterval(() => {
            const min = Math.floor(time / 60);
            const sec = time % 60;
            display.textContent = `${min}:${sec < 10 ? '0' : ''}${sec}`;
            time--;
            if (time < 0) {
                clearInterval(timers[type]);
                display.textContent = "â° Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯!";
                playAlarm();
            }
        }, 1000);
    }

    function stopTimer(type) {
        clearInterval(timers[type]);
        document.getElementById(type + "Timer").textContent = "--:--";
    }
</script>
</body>
</html>
